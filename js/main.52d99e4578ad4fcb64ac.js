/*! For license information please see main.52d99e4578ad4fcb64ac.js.LICENSE.txt */
(()=>{function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(){"use strict";t=function(){return o};var n,o={},r=Object.prototype,i=r.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},c=a.iterator||"@@iterator",l=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function u(e,t,n,o){return Object.defineProperty(e,t,{value:n,enumerable:!o,configurable:!o,writable:!o})}try{u({},"")}catch(n){u=function(e,t,n){return e[t]=n}}function d(e,t,o,r){var i=t&&t.prototype instanceof w?t:w,a=Object.create(i.prototype);return u(a,"_invoke",function(e,t,o){var r=1;return function(i,a){if(3===r)throw Error("Generator is already running");if(4===r){if("throw"===i)throw a;return{value:n,done:!0}}for(o.method=i,o.arg=a;;){var c=o.delegate;if(c){var l=x(c,o);if(l){if(l===h)continue;return l}}if("next"===o.method)o.sent=o._sent=o.arg;else if("throw"===o.method){if(1===r)throw r=4,o.arg;o.dispatchException(o.arg)}else"return"===o.method&&o.abrupt("return",o.arg);r=3;var s=f(e,t,o);if("normal"===s.type){if(r=o.done?4:2,s.arg===h)continue;return{value:s.arg,done:o.done}}"throw"===s.type&&(r=4,o.method="throw",o.arg=s.arg)}}}(e,o,new M(r||[])),!0),a}function f(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}o.wrap=d;var h={};function w(){}function p(){}function g(){}var m={};u(m,c,(function(){return this}));var v=Object.getPrototypeOf,k=v&&v(v(T([])));k&&k!==r&&i.call(k,c)&&(m=k);var C=g.prototype=w.prototype=Object.create(m);function y(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function b(t,n){function o(r,a,c,l){var s=f(t[r],t,a);if("throw"!==s.type){var u=s.arg,d=u.value;return d&&"object"==e(d)&&i.call(d,"__await")?n.resolve(d.__await).then((function(e){o("next",e,c,l)}),(function(e){o("throw",e,c,l)})):n.resolve(d).then((function(e){u.value=e,c(u)}),(function(e){return o("throw",e,c,l)}))}l(s.arg)}var r;u(this,"_invoke",(function(e,t){function i(){return new n((function(n,r){o(e,t,n,r)}))}return r=r?r.then(i,i):i()}),!0)}function x(e,t){var o=t.method,r=e.i[o];if(r===n)return t.delegate=null,"throw"===o&&e.i.return&&(t.method="return",t.arg=n,x(e,t),"throw"===t.method)||"return"!==o&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+o+"' method")),h;var i=f(r,e.i,t.arg);if("throw"===i.type)return t.method="throw",t.arg=i.arg,t.delegate=null,h;var a=i.arg;return a?a.done?(t[e.r]=a.value,t.next=e.n,"return"!==t.method&&(t.method="next",t.arg=n),t.delegate=null,h):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,h)}function P(e){this.tryEntries.push(e)}function I(e){var t=e[4]||{};t.type="normal",t.arg=n,e[4]=t}function M(e){this.tryEntries=[[-1]],e.forEach(P,this),this.reset(!0)}function T(t){if(null!=t){var o=t[c];if(o)return o.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,a=function e(){for(;++r<t.length;)if(i.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=n,e.done=!0,e};return a.next=a}}throw new TypeError(e(t)+" is not iterable")}return p.prototype=g,u(C,"constructor",g),u(g,"constructor",p),p.displayName=u(g,s,"GeneratorFunction"),o.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},o.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,g):(e.__proto__=g,u(e,s,"GeneratorFunction")),e.prototype=Object.create(C),e},o.awrap=function(e){return{__await:e}},y(b.prototype),u(b.prototype,l,(function(){return this})),o.AsyncIterator=b,o.async=function(e,t,n,r,i){void 0===i&&(i=Promise);var a=new b(d(e,t,n,r),i);return o.isGeneratorFunction(t)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},y(C),u(C,s,"Generator"),u(C,c,(function(){return this})),u(C,"toString",(function(){return"[object Generator]"})),o.keys=function(e){var t=Object(e),n=[];for(var o in t)n.unshift(o);return function e(){for(;n.length;)if((o=n.pop())in t)return e.value=o,e.done=!1,e;return e.done=!0,e}},o.values=T,M.prototype={constructor:M,reset:function(e){if(this.prev=this.next=0,this.sent=this._sent=n,this.done=!1,this.delegate=null,this.method="next",this.arg=n,this.tryEntries.forEach(I),!e)for(var t in this)"t"===t.charAt(0)&&i.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=n)},stop:function(){this.done=!0;var e=this.tryEntries[0][4];if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function o(n){a.type="throw",a.arg=e,t.next=n}for(var r=t.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r],a=i[4],c=this.prev,l=i[1],s=i[2];if(-1===i[0])return o("end"),!1;if(!l&&!s)throw Error("try statement without catch or finally");if(null!=i[0]&&i[0]<=c){if(c<l)return this.method="next",this.arg=n,o(l),!0;if(c<s)return o(s),!1}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o[0]>-1&&o[0]<=this.prev&&this.prev<o[2]){var r=o;break}}r&&("break"===e||"continue"===e)&&r[0]<=t&&t<=r[2]&&(r=null);var i=r?r[4]:{};return i.type=e,i.arg=t,r?(this.method="next",this.next=r[2],h):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n[2]===e)return this.complete(n[4],n[3]),I(n),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n[0]===e){var o=n[4];if("throw"===o.type){var r=o.arg;I(n)}return r}}throw Error("illegal catch attempt")},delegateYield:function(e,t,o){return this.delegate={i:T(e),r:t,n:o},"next"===this.method&&(this.arg=n),h}},o}function n(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=c(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0,r=function(){};return{s:r,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){l=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(l)throw i}}}}function o(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var o,r,i,a,c=[],l=!0,s=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(o=i.call(n)).done)&&(c.push(o.value),c.length!==t);l=!0);}catch(e){s=!0,r=e}finally{try{if(!l&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(s)throw r}}return c}}(e,t)||c(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(e,t,n,o,r,i,a){try{var c=e[i](a),l=c.value}catch(e){return void n(e)}c.done?t(l):Promise.resolve(l).then(o,r)}function i(e){return function(){var t=this,n=arguments;return new Promise((function(o,i){var a=e.apply(t,n);function c(e){r(a,o,i,c,l,"next",e)}function l(e){r(a,o,i,c,l,"throw",e)}c(void 0)}))}}function a(e){return function(e){if(Array.isArray(e))return l(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||c(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(e,t){if(e){if("string"==typeof e)return l(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(e,t):void 0}}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}var s=document.getElementById("chessboard");console.log("Initial board DOM element:",s);document.getElementById("debug");var u=document.getElementById("game-status"),d=document.getElementById("move-list"),f=document.getElementById("white-captured"),h=document.getElementById("black-captured"),w=document.getElementById("promotion-modal"),p=document.getElementById("white-time"),g=document.getElementById("black-time"),m=document.querySelector(".white-clock"),v=document.querySelector(".black-clock"),k=0,C=1,y="local",b="ai",x="online",P=y,I={initialTime:600,whiteTime:600,blackTime:600,timerInterval:null,isRunning:!1,activePlayer:k,lowTimeThreshold:60},M=null;window.turn=k;var T=null,A=null,E={whiteCanCastleKingside:!0,whiteCanCastleQueenside:!0,blackCanCastleKingside:!0,blackCanCastleQueenside:!0,enPassantTarget:null,lastPawnDoubleMove:null,moveHistory:[],capturedPieces:{white:[],black:[]},moveCount:1,gameOver:!1,check:!1,checkmate:!1,stalemate:!1,fiftyMoveRule:!1,insufficientMaterial:!1,threefoldRepetition:!1,castlingRightsSnapshot:null},O={white:{king:"♔",queen:"♕",rook:"♖",bishop:"♗",knight:"♘",pawn:"♙",checked:!1,checkSquare:0,kingRow:7,kingCol:4},black:{king:"♚",queen:"♛",rook:"♜",bishop:"♝",knight:"♞",pawn:"♟",checked:!1,checkSquare:0,kingRow:0,kingCol:4}},S=[O.white.king,O.white.queen,O.white.rook,O.white.bishop,O.white.knight,O.white.pawn],R=[O.black.king,O.black.queen,O.black.rook,O.black.bishop,O.black.knight,O.black.pawn];function L(e){var t=Math.floor(e/60),n=e%60;return"".concat(t.toString().padStart(2,"0"),":").concat(n.toString().padStart(2,"0"))}function q(){p.textContent=L(I.whiteTime),g.textContent=L(I.blackTime),p.classList.toggle("low-time",I.whiteTime<=I.lowTimeThreshold),g.classList.toggle("low-time",I.blackTime<=I.lowTimeThreshold),m.classList.toggle("active-clock",I.activePlayer===k),v.classList.toggle("active-clock",I.activePlayer===C)}function _(){I.isRunning||(I.timerInterval=setInterval((function(){I.activePlayer===k?(I.whiteTime--,I.whiteTime<=0&&B(k)):(I.blackTime--,I.blackTime<=0&&B(C)),q()}),1e3),I.isRunning=!0)}function D(){I.timerInterval&&(clearInterval(I.timerInterval),I.timerInterval=null,I.isRunning=!1)}function B(e){D(),E.gameOver=!0;var t=e===k?"Black":"White";u.textContent="Time's up! ".concat(t," wins by timeout!"),ae()}function G(){f.innerHTML="",h.innerHTML="",E.capturedPieces.white.forEach((function(e){var t=document.createElement("span");t.textContent=e,f.appendChild(t)})),E.capturedPieces.black.forEach((function(e){var t=document.createElement("span");t.textContent=e,h.appendChild(t)}))}function N(){d.innerHTML="";for(var e=0;e<E.moveHistory.length;e+=2){var t=Math.floor(e/2)+1,n=E.moveHistory[e],o=E.moveHistory[e+1],r=document.createElement("div");r.classList.add("move-item");var i=document.createElement("div");i.classList.add("move-number"),i.textContent="".concat(t,".");var a=document.createElement("div");a.classList.add("move-text");var c="".concat(K(n));o&&(c+=" ".concat(K(o))),a.textContent=c,r.appendChild(i),r.appendChild(a),d.appendChild(r)}d.scrollTop=d.scrollHeight}function K(e){if(!e)return"";var t="abcdefgh",n="87654321",o=t[e.from.col],r=(e.from.row,t[e.to.col]),i=n[e.to.row],a="",c=e.pieceMovedOriginal;if(c===O.white.king||c===O.black.king?a="K":c===O.white.queen||c===O.black.queen?a="Q":c===O.white.rook||c===O.black.rook?a="R":c===O.white.bishop||c===O.black.bishop?a="B":c!==O.white.knight&&c!==O.black.knight||(a="N"),e.wasCastling)return"kingside"===e.castlingDetails.side?"O-O":"O-O-O";var l=e.capturedPieceDirectly||e.wasEnPassantCapture?"x":"",s="";if(e.wasPromotion&&e.promotedToPieceType){var u="";switch(e.promotedToPieceType){case"queen":u="Q";break;case"rook":u="R";break;case"bishop":u="B";break;case"knight":u="N"}s="=".concat(u)}var d="";e.resultedInCheckmate?d="#":e.resultedInCheck&&(d="+");return""===a?l?"".concat(o,"x").concat(r).concat(i).concat(s).concat(d):"".concat(r).concat(i).concat(s).concat(d):"".concat(a).concat("").concat(l).concat(r).concat(i).concat(d)}function Q(e,t){var n=document.createElement("div");n.className="piece-animation-clone",n.textContent=e;var o=t.getBoundingClientRect();n.style.position="fixed",n.style.left="".concat(o.left,"px"),n.style.top="".concat(o.top,"px"),n.style.width="".concat(o.width,"px"),n.style.height="".concat(o.height,"px"),n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center";var r=window.getComputedStyle(t);return n.style.fontSize=r.fontSize||"2em",n.style.zIndex="1001",n.style.pointerEvents="none",document.body.appendChild(n),n}function H(e,t,n){return j.apply(this,arguments)}function j(){return(j=i(t().mark((function e(n,o,r){return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e){if(!n||!o||!r)return console.warn("Animation skipped due to missing parameters",n,o,r),void e();var t=Q(r,n);n.textContent="";var i=o.getBoundingClientRect(),a=t.getBoundingClientRect(),c=i.left-a.left,l=i.top-a.top;t.style.transition="transform 0.3s ease-out",requestAnimationFrame((function(){t.style.transform="translate(".concat(c,"px, ").concat(l,"px)")})),t.addEventListener("transitionend",(function(){t.remove(),e()}),{once:!0})})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function W(e){e&&(e.classList.add("invalidSquare"),setTimeout((function(){e.classList.remove("invalidSquare")}),150))}function F(e,t,n){var r=n===k?C:k,i=r===k?O.white:O.black,a=r===k?1:-1;if(e-a>=0&&e-a<8){if(t>0&&A[8*(e-a)+(t-1)].textContent===i.pawn)return!0;if(t<7&&A[8*(e-a)+(t+1)].textContent===i.pawn)return!0}for(var c=0,l=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];c<l.length;c++){var s=o(l[c],2),u=e+s[0],d=t+s[1];if(u>=0&&u<8&&d>=0&&d<8&&A[8*u+d].textContent===i.knight)return!0}for(var f=0,h=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];f<h.length;f++){var w=o(h[f],2),p=e+w[0],g=t+w[1];if(p>=0&&p<8&&g>=0&&g<8&&A[8*p+g].textContent===i.king)return!0}for(var m=0,v=[[-1,0],[1,0],[0,-1],[0,1]];m<v.length;m++)for(var y=o(v[m],2),b=y[0],x=y[1],P=e+b,I=t+x;P>=0&&P<8&&I>=0&&I<8;){var M=A[8*P+I].textContent;if(""!==M){if(M===i.rook||M===i.queen)return!0;break}P+=b,I+=x}for(var T=0,E=[[-1,-1],[-1,1],[1,-1],[1,1]];T<E.length;T++)for(var S=o(E[T],2),R=S[0],L=S[1],q=e+R,_=t+L;q>=0&&q<8&&_>=0&&_<8;){var D=A[8*q+_].textContent;if(""!==D){if(D===i.bishop||D===i.queen)return!0;break}q+=R,_+=L}return!1}function U(e){var t=e===k?O.white:O.black;if(void 0===t.kingRow||void 0===t.kingCol){console.error("King position undefined for color:",e,t);for(var n=0;n<8;n++){for(var o=0;o<8;o++)if(A[8*n+o].textContent===t.king){t.kingRow=n,t.kingCol=o,console.warn("King position dynamically found. Ensure it is updated correctly.");break}if(void 0!==t.kingRow)break}if(void 0===t.kingRow)return!0}return F(t.kingRow,t.kingCol,e)}function z(e,t,n,o){var r=[],i=o===k?R:S,a=o===k?-1:1,c=o===k?6:1;t+a>=0&&t+a<8&&""===A[8*(t+a)+n].textContent&&(r.push(A[8*(t+a)+n]),t===c&&""===A[8*(t+2*a)+n].textContent&&r.push(A[8*(t+2*a)+n]));for(var l=0,s=[-1,1];l<s.length;l++){var u=n+s[l];if(u>=0&&u<8&&t+a>=0&&t+a<8){var d=A[8*(t+a)+u];d&&i.includes(d.textContent)&&r.push(d),E.enPassantTarget&&t+a===E.enPassantTarget.row&&u===E.enPassantTarget.col&&""===d.textContent&&r.push(d)}}return r}function V(e,t,n,r){for(var i=[],a=r===k?R:S,c=0,l=[[-1,0],[1,0],[0,-1],[0,1]];c<l.length;c++)for(var s=o(l[c],2),u=s[0],d=s[1],f=t+u,h=n+d;f>=0&&f<8&&h>=0&&h<8;){var w=A[8*f+h];if(""!==w.textContent){if(a.includes(w.textContent)){i.push(w);break}break}i.push(w),f+=u,h+=d}return i}function Y(e,t,n,r){for(var i=[],a=r===k?S:R,c=0,l=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];c<l.length;c++){var s=o(l[c],2),u=t+s[0],d=n+s[1];if(u>=0&&u<8&&d>=0&&d<8){var f=A[8*u+d];a.includes(f.textContent)||i.push(f)}}return i}function $(e,t,n,r){for(var i=[],a=r===k?R:S,c=0,l=[[-1,-1],[-1,1],[1,-1],[1,1]];c<l.length;c++)for(var s=o(l[c],2),u=s[0],d=s[1],f=t+u,h=n+d;f>=0&&f<8&&h>=0&&h<8;){var w=A[8*f+h];if(""!==w.textContent){if(a.includes(w.textContent)){i.push(w);break}break}i.push(w),f+=u,h+=d}return i}function J(e,t,n,o){return[].concat(a(V(0,t,n,o)),a($(0,t,n,o)))}function X(e,t,n,r){for(var i=[],a=r===k?S:R,c=0,l=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];c<l.length;c++){var s=o(l[c],2),u=t+s[0],d=n+s[1];if(u>=0&&u<8&&d>=0&&d<8){var f=A[8*u+d];a.includes(f.textContent)||i.push(f)}}var h=r===k?7:0,w=r===k?E.whiteCanCastleKingside:E.blackCanCastleKingside,p=r===k?E.whiteCanCastleQueenside:E.blackCanCastleQueenside,g=r===k?O.white.rook:O.black.rook;return t===h&&4===n&&(w&&""===A[8*h+5].textContent&&""===A[8*h+6].textContent&&A[8*h+7].textContent===g&&i.push(A[8*h+6]),p&&""===A[8*h+3].textContent&&""===A[8*h+2].textContent&&""===A[8*h+1].textContent&&A[8*h+0].textContent===g&&i.push(A[8*h+2])),i}function Z(e,t){var n=e.textContent,o=parseInt(e.dataset.row),r=parseInt(e.dataset.col);if(t===k){if(n===O.white.pawn)return z(0,o,r,k);if(n===O.white.rook)return V(0,o,r,k);if(n===O.white.knight)return Y(0,o,r,k);if(n===O.white.bishop)return $(0,o,r,k);if(n===O.white.queen)return J(0,o,r,k);if(n===O.white.king)return X(0,o,r,k)}else{if(n===O.black.pawn)return z(0,o,r,C);if(n===O.black.rook)return V(0,o,r,C);if(n===O.black.knight)return Y(0,o,r,C);if(n===O.black.bishop)return $(0,o,r,C);if(n===O.black.queen)return J(0,o,r,C);if(n===O.black.king)return X(0,o,r,C)}return[]}function ee(e,t,n){if(!e||!t)return!1;var o=e.textContent,r=t.textContent,i=(parseInt(e.dataset.row),parseInt(e.dataset.col)),a=parseInt(t.dataset.row),c=parseInt(t.dataset.col),l=n===k?O.white:O.black,s=l.kingRow,u=l.kingCol,d=null,f=null,h=!1,w=null,p=null,g=null;if(o===l.king&&2===Math.abs(i-c)){h=!0;var m=n===k?7:0,v=n===k?O.white.rook:O.black.rook;if(U(n))return!1;if(6===c){if(!(n===k?E.whiteCanCastleKingside:E.blackCanCastleKingside)||""!==A[8*m+5].textContent||""!==A[8*m+6].textContent||A[8*m+7].textContent!==v||F(m,5,n)||F(m,6,n))return!1;w=A[8*m+7],p=A[8*m+5]}else{if(!(n===k?E.whiteCanCastleQueenside:E.blackCanCastleQueenside)||""!==A[8*m+1].textContent||""!==A[8*m+2].textContent||""!==A[8*m+3].textContent||A[8*m+0].textContent!==v||F(m,3,n)||F(m,2,n))return!1;w=A[8*m+0],p=A[8*m+3]}p&&(g=p.textContent)}(t.textContent=o,e.textContent="",o===l.king&&(l.kingRow=a,l.kingCol=c),h&&w&&p&&(p.textContent=w.textContent,w.textContent=""),o===(n===k?O.white.pawn:O.black.pawn)&&E.enPassantTarget&&a===E.enPassantTarget.row&&c===E.enPassantTarget.col&&""===r)&&((d=A[8*(n===k?a+1:a-1)+c])&&((f=d.textContent)===(n===k?O.black.pawn:O.white.pawn)?d.textContent="":(d=null,f=null)));var C=U(n);return e.textContent=o,t.textContent=r,l.kingRow=s,l.kingCol=u,h&&w&&p&&(w.textContent=p.textContent,p.textContent=g),d&&f&&(d.textContent=f),!C}function te(e){var t=[],o=e===k?S:R;if(!A)return[];for(var r=0;r<A.length;r++){var i=A[r];if(o.includes(i.textContent)){var a,c=n(Z(i,e));try{for(c.s();!(a=c.n()).done;){var l=a.value;ee(i,l,e)&&t.push({from:i,to:l})}}catch(e){c.e(e)}finally{c.f()}}}return t}function ne(){var e;console.log("initChessApp: Entered function."),console.log("initChessApp: About to call createChessboard and placePieces."),function(){if(console.log("createChessboard called. board DOM element:",s),s){s.innerHTML="";for(var e=0,t=0;t<8;t++)for(var n=function(){var n=document.createElement("div");n.classList.add("square"),n.classList.add((t+o)%2==0?"white":"black"),n.dataset.row=t,n.dataset.col=o,n.addEventListener("click",(function(){return oe(n)})),s.appendChild(n),e++},o=0;o<8;o++)n();console.log("Number of squares created and appended in createChessboard:",e),A=document.querySelectorAll(".square"),console.log("Number of .square elements found by querySelectorAll after createChessboard:",A.length)}else console.error("Chessboard DOM element 'chessboard' not found in createChessboard. Cannot create board.")}(),e=[["rook","knight","bishop","queen","king","bishop","knight","rook"],Array(8).fill("pawn")].concat(a(Array(4).fill(Array(8).fill(null))),[Array(8).fill("pawn"),["rook","knight","bishop","queen","king","bishop","knight","rook"]]),A||(console.warn("placePieces: squares global variable is not set. Querying again."),A=document.querySelectorAll(".square")),console.log("placePieces: Number of squares found:",A?A.length:0),A&&0!==A.length?(A.forEach((function(e,t){return e.textContent=""})),e.forEach((function(e,t){e.forEach((function(e,n){if(e){var o=A[8*t+n],r=t<4?"black":"white";o.textContent=O[r][e]}}))})),O.white.kingRow=7,O.white.kingCol=4,O.black.kingRow=0,O.black.kingCol=4,E.whiteCanCastleKingside=!0,E.whiteCanCastleQueenside=!0,E.blackCanCastleKingside=!0,E.blackCanCastleQueenside=!0,E.enPassantTarget=null):console.error("placePieces: No squares found to place pieces on. Has createChessboard run successfully?"),A=document.querySelectorAll(".square"),function(){if(console.log("setupPromotionModal: Entered function. promotionModal DOM element:",w),!w)return void console.error("setupPromotionModal: promotionModal element not found! Cannot set up listeners.");w.querySelectorAll(".promotion-piece").forEach((function(e){e.addEventListener("click",(function(e){!function(e){if(!T||!T.moveData)return console.error("Pending promotion or moveData is missing."),void(w.style.display="none");var t,n=T,o=(n.fromSquare,n.toSquare),r=n.playerColor,i=n.fromIndex,a=n.toIndex,c=n.moveData,l=r===k?O.white:O.black;switch(e){case"queen":default:t=l.queen;break;case"rook":t=l.rook;break;case"bishop":t=l.bishop;break;case"knight":t=l.knight}if(o.textContent=t,c.promotedToPieceType=e,E.moveHistory.push(c),P===x&&window.MP&&window.MP.onlineModeActive&&"function"==typeof window.sendMove){var s={fromIndex:i,toIndex:a,promotion:e};console.log("Sending promotion choice to opponent:",s),window.sendMove(s)}T=null,w.style.display="none";var u=r===k?C:k;window.turn=u,I.activePlayer=u,"function"==typeof window.updateState?(window.updateState({turn:u}),console.log("SCRIPT_LOG: selectPromotionPiece - Called window.updateState({ turn: ".concat(u," })"))):console.warn("SCRIPT_LOG: selectPromotionPiece - window.updateState is not a function. AI might not get correct turn.");q();var d=window.turn;if(U(d)){c.resultedInCheck=!0,0===te(d).length&&(c.resultedInCheckmate=!0)}else c.resultedInCheck=!1,c.resultedInCheckmate=!1;N(),ae(),ce(),console.log("SCRIPT_LOG: selectPromotionPiece - After promotion. Current game mode: ".concat(P,", AI Active: ").concat(window.aiActive,", Current turn: ").concat(window.turn,", AI Color: ").concat(window.aiColor,", Game Over: ").concat(E.gameOver)),P===b&&window.aiActive&&window.turn===window.aiColor&&!E.gameOver?"function"==typeof checkAITurn?(console.log("SCRIPT_LOG: selectPromotionPiece - Conditions met for AI turn. Calling checkAITurn."),setTimeout(checkAITurn,100)):console.error("SCRIPT_LOG: selectPromotionPiece - checkAITurn function not found!"):console.log("SCRIPT_LOG: selectPromotionPiece - Conditions NOT met for AI turn after promotion.")}(e.target.dataset.piece)}))}))}();var t=document.getElementById("undo-button");t&&t.addEventListener("click",ge);var n=new URLSearchParams(window.location.search).get("mode");if(n)switch(n){case b:P=b;var o=document.getElementById("ai-toggle");o&&(o.checked=!0,"function"==typeof toggleAI?(console.log("SCRIPT_LOG: initChessApp - Auto-enabling AI due to URL param."),toggleAI(!0)):console.error("SCRIPT_LOG: initChessApp - toggleAI function not found!"));break;case x:P=x,"function"==typeof initMultiplayer?initMultiplayer():console.error("Multiplayer module not loaded");break;default:P=y}ie(),function(){if(!document.getElementById("back-to-home")){var e=document.createElement("a");e.id="back-to-home",e.href="home.html",e.textContent="← Back to Home",e.className="back-link",(document.querySelector(".container")||document.body).prepend(e)}}()}function oe(e){return re.apply(this,arguments)}function re(){return(re=i(t().mark((function e(n){var o,r,i,a,c,l;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!E.gameOver){e.next=2;break}return e.abrupt("return");case 2:if(P!==x||!window.MP||!window.MP.onlineModeActive){e.next=6;break}if(!(window.MP.playerColor===k&&window.turn!==k||window.MP.playerColor===C&&window.turn!==C)){e.next=6;break}return console.log("Not your turn in online mode"),e.abrupt("return");case 6:if(I.isRunning||0!==E.moveHistory.length||P===x||E.gameOver||_(),P!==b||!window.aiActive||window.isAIMakingMove){e.next=20;break}if(window.turn!==window.aiColor){e.next=11;break}return console.log("Human click ignored: It is AI's turn."),e.abrupt("return");case 11:if(o=window.aiColor===k?C:k,r=n.textContent,i=o===k?S:R,!M||window.turn===o){e.next=17;break}return ce(),e.abrupt("return");case 17:if(M||i.includes(r)){e.next=20;break}return console.log("Cannot select opponent or AI pieces in AI mode"),e.abrupt("return");case 20:if(a=n.textContent,c=window.turn,l=c===k?S:R,!M){e.next=43;break}if(n!==M){e.next=29;break}ce(),e.next=41;break;case 29:if(!l.includes(M.textContent)){e.next=41;break}if(!n.classList.contains("movelight")&&!n.classList.contains("takelight")){e.next=40;break}if(c!==k){e.next=36;break}return e.next=34,de(n,parseInt(n.dataset.row),parseInt(n.dataset.col));case 34:e.next=38;break;case 36:return e.next=38,he(n,parseInt(n.dataset.row),parseInt(n.dataset.col));case 38:e.next=41;break;case 40:l.includes(a)?le(n,c):W(n);case 41:e.next=44;break;case 43:l.includes(a)&&le(n,c);case 44:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ie(){if(E.gameOver)if(E.checkmate){var e=window.turn===k?"Black":"White";u.textContent="Checkmate! ".concat(e," wins!")}else E.stalemate?u.textContent="Stalemate! Game drawn.":E.fiftyMoveRule?u.textContent="Draw by fifty-move rule.":E.insufficientMaterial?u.textContent="Draw by insufficient material.":E.threefoldRepetition&&(u.textContent="Draw by threefold repetition.");else{var t=window.turn===k?"White":"Black";window.turn;E.check?u.textContent="".concat(t," to move (in check)"):P===x&&window.MP&&window.MP.onlineModeActive?window.MP.playerColor===k&&window.turn===k||window.MP.playerColor===C&&window.turn===C?u.textContent="Your turn to move":u.textContent="Opponent's turn to move":u.textContent="".concat(t," to move")}}function ae(){var e=window.turn;E.check=U(e),0===te(e).length?(E.gameOver=!0,E.check?E.checkmate=!0:E.stalemate=!0,D()):(E.gameOver=!1,E.checkmate=!1,E.stalemate=!1),ie()}function ce(){M&&M.classList.remove("highlight"),A.forEach((function(e){e.classList.remove("movelight"),e.classList.remove("takelight")}));var e=A[8*O.white.kingRow+O.white.kingCol],t=A[8*O.black.kingRow+O.black.kingCol];U(k)?e.classList.add("dangerlight"):e.classList.remove("dangerlight"),U(C)?t.classList.add("dangerlight"):t.classList.remove("dangerlight"),M=null}function le(e,t){ce(),M=e,e.classList.add("highlight"),Z(e,t).forEach((function(n){ee(e,n,t)&&n.classList.add(""===n.textContent?"movelight":"takelight")}))}function se(e,t,n){return ue.apply(this,arguments)}function ue(){return(ue=i(t().mark((function e(n,o,r){var i,a,c,l,s,u,d,f,h,w,p,g,m,v,y,M,S;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=n.textContent,a=o.textContent,c=parseInt(n.dataset.row),l=parseInt(n.dataset.col),s=parseInt(o.dataset.row),u=parseInt(o.dataset.col),d={from:{row:c,col:l},to:{row:s,col:u},pieceMovedOriginal:i,capturedPieceDirectly:null,wasPromotion:!1,promotedToPieceType:null,wasCastling:!1,castlingDetails:null,wasEnPassantCapture:!1,enPassantVictimDetails:null,previousEnPassantTarget:E.enPassantTarget,prevWhiteCanCastleKingside:E.whiteCanCastleKingside,prevWhiteCanCastleQueenside:E.whiteCanCastleQueenside,prevBlackCanCastleKingside:E.blackCanCastleKingside,prevBlackCanCastleQueenside:E.blackCanCastleQueenside,playerColor:r,resultedInCheck:!1,resultedInCheckmate:!1},e.next=9,H(n,o,i);case 9:if(o.textContent=i,""!==a&&(d.capturedPieceDirectly=a,r===k?E.capturedPieces.white.push(a):E.capturedPieces.black.push(a)),i===O.white.king&&(O.white.kingRow=s,O.white.kingCol=u),i===O.black.king&&(O.black.kingRow=s,O.black.kingCol=u),i!==(r===k?O.white.king:O.black.king)||2!==Math.abs(l-u)){e.next=21;break}return d.wasCastling=!0,f=r===k?7:0,h=r===k?O.white.rook:O.black.rook,6===u?(w=A[8*f+7],p=A[8*f+5],d.castlingDetails={side:"kingside",rookOriginalSquare:{row:f,col:7},rookNewSquare:{row:f,col:5}}):(w=A[8*f+0],p=A[8*f+3],d.castlingDetails={side:"queenside",rookOriginalSquare:{row:f,col:0},rookNewSquare:{row:f,col:3}}),e.next=20,H(w,p,h);case 20:p.textContent=h;case 21:if(i===O.white.king?(E.whiteCanCastleKingside=!1,E.whiteCanCastleQueenside=!1):i===O.black.king?(E.blackCanCastleKingside=!1,E.blackCanCastleQueenside=!1):i===O.white.rook?(7===c&&0===l&&(E.whiteCanCastleQueenside=!1),7===c&&7===l&&(E.whiteCanCastleKingside=!1)):i===O.black.rook&&(0===c&&0===l&&(E.blackCanCastleQueenside=!1),0===c&&7===l&&(E.blackCanCastleKingside=!1)),a===O.white.rook&&7===s&&0===u&&(E.whiteCanCastleQueenside=!1),a===O.white.rook&&7===s&&7===u&&(E.whiteCanCastleKingside=!1),a===O.black.rook&&0===s&&0===u&&(E.blackCanCastleQueenside=!1),a===O.black.rook&&0===s&&7===u&&(E.blackCanCastleKingside=!1),g=r===k?O.white.pawn:O.black.pawn,i===g&&E.enPassantTarget&&s===E.enPassantTarget.row&&u===E.enPassantTarget.col&&!a&&(d.wasEnPassantCapture=!0,v=A[8*(m=r===k?s+1:s-1)+u],d.enPassantVictimDetails={piece:v.textContent,row:m,col:u},r===k?E.capturedPieces.white.push(v.textContent):E.capturedPieces.black.push(v.textContent),v.textContent=""),i===g&&2===Math.abs(c-s)?E.enPassantTarget={row:(c+s)/2,col:u}:E.enPassantTarget=null,y=r===k?0:7,i===g&&s===y&&(d.wasPromotion=!0,T.moveData=d),d.wasPromotion||(M=r===k?C:k,window.turn=M,I.activePlayer=M,window.aiActive&&engineReady&&M===window.aiColor&&!E.gameOver&&(console.log("Turn changed to ".concat(M===k?"White":"Black",", requesting AI move...")),requestAIMove()),q(),E.moveHistory.push(d)),U(S=r===k?C:k)&&(d.resultedInCheck=!0,0===te(S).length&&(d.resultedInCheckmate=!0)),G(),N(),ce(),console.log("Checking multiplayer conditions:",{currentGameMode:P,GAME_MODE_ONLINE:x,isMatchingMode:P===x,MP:window.MP?"exists":"undefined",onlineActive:window.MP?window.MP.onlineModeActive:"N/A",socketConnected:window.MP&&window.MP.socket?window.MP.socket.connected:"N/A",playerColor:window.MP?window.MP.playerColor:"N/A",pieceColor:r,sendMoveFunction:"function"==typeof window.sendMove?"exists":"undefined"}),P===x&&window.MP&&window.MP.onlineModeActive&&window.MP.socket)if(console.log("Sending move to multiplayer system:",d),window.MP.playerColor===k&&r===k||window.MP.playerColor===C&&r===C)try{"function"!=typeof window.sendMove?(console.error("sendMove function not available! Attempting to use fallback."),window.MP.socket&&window.MP.socket.emit?(window.MP.socket.emit("make_move",{roomId:window.MP.roomId,move:"".concat(d.pieceMovedOriginal,",").concat(d.from.row,",").concat(d.from.col,",").concat(d.to.row,",").concat(d.to.col)}),console.log("Used socket.emit fallback to send move")):console.error("No fallback available for sending moves!")):(window.sendMove({piece:d.pieceMovedOriginal,from:d.from,to:d.to}),console.log("Move sent to multiplayer server via window.sendMove"))}catch(e){console.error("Error sending move to multiplayer server:",e)}else console.log("Not sending move - opponent's move reflection");d.wasPromotion?console.log("SCRIPT_LOG: handlePieceMove - Move was a promotion. AI turn check deferred to selectPromotionPiece."):(ae(),console.log("SCRIPT_LOG: handlePieceMove - After human move. Current game mode: ".concat(P,", AI Active: ").concat(window.aiActive,", Current turn: ").concat(window.turn,", AI Color: ").concat(window.aiColor,", Game Over: ").concat(E.gameOver)),P===b&&window.aiActive&&window.turn===window.aiColor&&!E.gameOver?"function"==typeof checkAITurn?(console.log("SCRIPT_LOG: handlePieceMove - Conditions met for AI turn. Calling checkAITurn."),setTimeout(checkAITurn,100)):console.error("SCRIPT_LOG: handlePieceMove - checkAITurn function not found!"):console.log("SCRIPT_LOG: handlePieceMove - Conditions NOT met for AI turn after human move."));case 40:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function de(e,t,n){return fe.apply(this,arguments)}function fe(){return(fe=i(t().mark((function e(n,o,r){return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,se(M,n,k);case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function he(e,t,n){return we.apply(this,arguments)}function we(){return(we=i(t().mark((function e(n,o,r){return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,se(M,n,C);case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function pe(){if(0!==E.moveHistory.length){var e=E.moveHistory.pop(),t=A[8*e.from.row+e.from.col],n=A[8*e.to.row+e.to.col],o=e.pieceMovedOriginal;if(e.wasPromotion&&(o=e.playerColor===k?O.white.pawn:O.black.pawn),t.textContent=o,e.capturedPieceDirectly&&!e.wasEnPassantCapture?(n.textContent=e.capturedPieceDirectly,e.playerColor===k?E.capturedPieces.white.pop():E.capturedPieces.black.pop()):e.wasCastling||e.wasEnPassantCapture||(n.textContent=""),e.pieceMovedOriginal===O.white.king?(O.white.kingRow=e.from.row,O.white.kingCol=e.from.col):e.pieceMovedOriginal===O.black.king&&(O.black.kingRow=e.from.row,O.black.kingCol=e.from.col),e.wasEnPassantCapture){n.textContent="";var r=e.enPassantVictimDetails;A[8*r.row+r.col].textContent=r.piece,e.playerColor===k?E.capturedPieces.white.pop():E.capturedPieces.black.pop()}if(e.wasCastling){var i=e.playerColor===k?7:0,a=e.playerColor===k?O.white.rook:O.black.rook;n.textContent="","kingside"===e.castlingDetails.side?(A[8*i+7].textContent=a,A[8*i+5].textContent=""):(A[8*i+0].textContent=a,A[8*i+3].textContent="")}E.enPassantTarget=e.previousEnPassantTarget,E.whiteCanCastleKingside=e.prevWhiteCanCastleKingside,E.whiteCanCastleQueenside=e.prevWhiteCanCastleQueenside,E.blackCanCastleKingside=e.prevBlackCanCastleKingside,E.blackCanCastleQueenside=e.prevBlackCanCastleQueenside,window.turn=e.playerColor,I.activePlayer=window.turn,E.gameOver=!1,E.checkmate=!1,E.stalemate=!1,G(),N(),ae(),ce(),q(),!I.isRunning&&E.moveHistory.length>0&&!E.gameOver&&_()}}function ge(){if(0!==E.moveHistory.length&&P!==x){var e=1;if(P===b&&window.aiActive)E.moveHistory[E.moveHistory.length-1].playerColor===window.aiColor&&E.moveHistory.length>1&&(e=2);for(var t=0;t<e;t++)E.moveHistory.length>0&&pe();P===b&&window.aiActive&&window.turn===window.aiColor&&!E.gameOver&&"function"==typeof checkAITurn&&setTimeout(checkAITurn,100)}}console.log("Script: Reached point before adding DOMContentLoaded listener."),document.addEventListener("DOMContentLoaded",(function(){console.log("Script: DOMContentLoaded event fired. About to call initChessApp."),ne()}))})();
//# sourceMappingURL=main.52d99e4578ad4fcb64ac.js.map